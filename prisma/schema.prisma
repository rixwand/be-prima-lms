generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserStatus {
  NOT_VERIFIED
  ACTIVE
  DISABLED
}

enum BlockType {
  RICH_TEXT
  VIDEO
  FILE
  EMBED
}

model RefreshSession {
  jti           String @id
  userId        Int
  expiresAt     DateTime

  revokedAt     DateTime?
  replacedByJti String? @unique @map("replaced_by_jti")

  createdAt     DateTime @default(now())
  updatedAt     DateTime  @updatedAt

  user          User  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  replacedBy    RefreshSession? @relation("SessionChain", fields: [replacedByJti], references: [jti])
  replacedFrom  RefreshSession[] @relation("SessionChain")

  @@index([userId, revokedAt, expiresAt])
  @@index([expiresAt])
  @@map("refresh_session")
}

model ActivationToken {
  id          String @id @default(cuid())
  userId      Int
  selector    String @unique @db.VarChar(64)
  tokenHash   String @map("token_hash") @db.VarChar(64)
  expiresAt   DateTime

  createdAt   DateTime @default(now())
  usedAt      DateTime?

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId, expiresAt])
  @@index([userId, usedAt])
  @@map("activation_tokens")
}

model User {
  id            Int @id @default(autoincrement())
  fullName      String @map("full_name")
  email         String @unique
  username      String
  profilePict   String? @map("profile_picture")
  passwordHash  String @map("password_hash")
  roleId        Int
  status        UserStatus @default(NOT_VERIFIED)
  createdAt     DateTime @default(now())

  roles         Role @relation(fields: [roleId], references: [id])
  session       RefreshSession[]
  activationToken ActivationToken[]
  courseOwned Course[] @relation("CourseOwner")
  reviewedCoursePublishes CoursePublishRequest[] @relation("ReviewedCourses")

  @@map("users")
}

model Role {
  id            Int @id @default(autoincrement())
  name          String @unique
  
  user          User[]
  perms    RolePermission[]

  @@map("roles")
}


model Permission {
  id            Int @id @default(autoincrement())
  action        String
  resource      String
  scope         String

  roles         RolePermission[]

  @@unique([scope, action, resource])      
  @@map("permissions")
}

model RolePermission {
  roleId        Int
  permissionId  Int

  role          Role       @relation(fields: [roleId], references: [id])
  permission    Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Course {
  id            Int @id @default(autoincrement())
  title         String 
  slug          String @unique
  ownerId       Int
  coverImage    String @map("cover_image")
  previewVideo  String? @map("preview_video")
  shortDescription String @db.Text @map("short_description")
  descriptionJson  Json? @map("description_json")
  priceAmount   Int @default(0)
  isFree        Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?
  takenDownAt       DateTime? 
  takenDownReason   String?

  owner         User  @relation("CourseOwner", fields: [ownerId], references: [id])
  sections      CourseSection[]
  tags          CourseTag[]   @relation("CourseTags")
  categories    CourseCategory[]
  discount      CourseDiscount[]
  coursePublishRequest CoursePublishRequest?


  metaDraft     CourseMetaDraft?
  
  @@map("courses")
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courses   CourseCategory[]
  courseDraft CourseDraftCategory[]

  @@map("categories")
}

model CourseCategory {
  courseId   Int
  categoryId Int
  isPrimary  Boolean @default(false)
  position   Int?

  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([courseId, categoryId])
  @@index([categoryId])
  @@map("course_categories")
}


model Tag {
  id        Int         @id @default(autoincrement())
  name      String      @unique
  slug      String      @unique
  courses   CourseTag[] @relation("CourseTags")
  courseDraft CourseDraftTag[]

  @@map("tags")
}

model CourseTag {
  courseId Int
  tagId    Int

  course   Course @relation("CourseTags", fields: [courseId], references: [id], onDelete: Cascade)
  tag      Tag    @relation("CourseTags", fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
  @@map("course_tags")
}

model CourseSection {
  id            Int @id @default(autoincrement())
  courseId      Int
  title         String
  position      Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?

  course        Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
  @@unique([courseId, position])
  @@map("course_sections")
}

model Lesson {
  id          Int @id @default(autoincrement())
  sectionId   Int
  slug        String
  title       String
  summary     String?
  position    Int
  durationSec Int?
  isPreview   Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?

  section     CourseSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  blocks      LessonBlock[]
  
  @@unique([sectionId, position])
  @@unique([sectionId, slug])

  @@map("lessons")
}

model LessonBlock {
  id          Int @id @default(autoincrement())
  lessonId    Int 
  position    Int
  type        BlockType
  textJson    Json?  @map("text_json")
  url         String?
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?

  lesson      Lesson @relation(fields: [lessonId],references: [id], onDelete: Cascade)

  @@unique([lessonId, position])
  @@map("lesson_blocks")
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

model CourseDiscount {
  id           Int           @id @default(autoincrement())
  courseId     Int
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)

  type         DiscountType
  value        Int
  startAt      DateTime?
  endAt        DateTime?
  isActive     Boolean        @default(true)
  label        String?

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([courseId, isActive])
  @@index([courseId, startAt, endAt])
  @@map("course_discount")

  }

  
enum PublishRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CoursePublishType {
  INITIAL
  UPDATE
}

model CoursePublishRequest {
  id           Int       @id @default(autoincrement())
  courseId     Int       @unique
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  type         CoursePublishType @default(INITIAL)
  status       PublishRequestStatus @default(PENDING)
  notes        String?
  reviewedById Int?
  reviewedBy   User?     @relation("ReviewedCourses", fields: [reviewedById], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  @@map("course_publish_requests")
}



model CourseMetaDraft {
  id          Int @id @default(autoincrement())
  courseId    Int @unique

  // marketing / public metadata
  title             String
  shortDescription  String
  descriptionJson   Json?
  previewVideo      String?
  coverImage        String
  priceAmount       Int
  isFree            Boolean

  // relations (draft-owned)
  draftTags        CourseDraftTag[]
  draftCategories  CourseDraftCategory[]
  draftDiscount    CourseDraftDiscount[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("course_meta_drafts")
}


model CourseDraftTag {
  draftId Int
  tagId   Int

  draft   CourseMetaDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  tag     Tag             @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([draftId, tagId])
  @@map("course_draft_tags")
}

model CourseDraftCategory {
  draftId    Int
  categoryId Int
  isPrimary  Boolean @default(false)
  position   Int?

  draft     CourseMetaDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  category  Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([draftId, categoryId])
  @@index([categoryId])
  @@map("course_draft_categories")
}

model CourseDraftDiscount {
  id        Int @id @default(autoincrement())
  draftId   Int

  type      DiscountType
  value     Int
  startAt   DateTime?
  endAt     DateTime?
  isActive  Boolean @default(true)
  label     String?

  draft     CourseMetaDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([draftId, isActive])
  @@index([draftId, startAt, endAt])
  @@map("course_draft_discounts")
}
